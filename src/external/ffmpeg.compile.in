#!/bin/bash

libdir=@{LIBDIR}
suffix=@{SUFFIX}

archive="ffmpeg-1.1.1.tar.bz2"
dir="ffmpeg-1.1.1"

soname()
{
	echo $(@{GETSO})
}

lib_deploy()
{
	for item
	do
		cp -Lf "$dir/lib${item}/"*.h "../include/lib${item}/" && \
		path="$dir/lib${item}/lib${item}$SUFFIX" && \
		so=$(library_soname "$path") && \
		cp -Lf "$path" "../lib/$so" && \
		cd ../lib/ && \
		ln -s "$so" lib${item}$SUFFIX && \
		cd ../external/ ||
		return 1
	done
	return 0
}

lib_install()
{
	for item
	do
		so=$(soname $item)
		link=$(readlink $item)
		cp -f "$item" "../lib/$link"
		if [ ! -e "../lib/$so" ]
		then ln -s "$link" "../lib/$so"
		fi
		cp -af "$item" ../lib/
	done
	return 0
}

for file in ../include/{libavformat,libavcodec,libavutil}
do if [ -d "$file" ]; then rm -r "$file"; fi
done

rm '../lib/libav'*

tar xfj "$archive" &&
cd "$dir" &&
./configure --enable-shared --disable-yasm --disable-bzlib --disable-vaapi --disable-libtheora --disable-libvorbis --disable-libopus --disable-libx264 --disable-libxvid --shlibdir="$libdir" > /dev/null &&
make > /dev/null &&
cd .. &&
mkdir -p ../include/{libavutil,libavcodec,libavformat} &&
cp -af "$dir/libavutil/"*.h "../include/libavutil/" &&
cp -af "$dir/libavcodec/"*.h "../include/libavcodec/" &&
cp -af "$dir/libavformat/"*.h "../include/libavformat/" &&
lib_install "$dir/libavutil/libavutil$suffix" "$dir/libavcodec/libavcodec$suffix" "$dir/libavformat/libavformat$suffix" &&
rm -rf "$dir" > /dev/null &&
echo 'Success'
